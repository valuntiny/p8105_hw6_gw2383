p8105\_hw6\_gw2383
================
Guojing Wu
11/23/2018

-   [Problem 1](#problem-1)
    -   [Tidy data](#tidy-data)
    -   [a logistic regression](#a-logistic-regression)
    -   [run `glm` for each of the cities](#run-glm-for-each-of-the-cities)

Problem 1
---------

### Tidy data

``` r
homi_df = 
  read.csv("./data/problem1/homicide-data.csv") %>% 
  janitor::clean_names() %>% 
  mutate(city_state = paste(city, state, sep = ", "), 
         solved = ifelse(disposition == "Closed by arrest", 1, 0), # a binary indicator
         victim_race = ifelse(victim_race == "White", "White", "Nonwhite"), 
         victim_race = factor(victim_race, levels = c("White", "Nonwhite")), # a white / non white indicator
         victim_age = as.numeric(victim_age)) %>% 
  filter(!(city_state %in% c("Dallas, TX", "Phoenix, AZ", "Kansas City, MO", "Tulsa, AL"))) # filter cities
```

### a logistic regression

``` r
# first fit it
fit_logistic =
  homi_df %>% 
  glm(solved ~ victim_age + victim_sex + victim_race, data = ., family = binomial())

# then compute the odds ratio
fit_logistic %>% 
  broom::tidy(conf.int = T) %>% 
  mutate(OR = exp(estimate), 
         conf.low = exp(conf.low), 
         conf.high = exp(conf.high)) %>% 
  select(term, OR, conf.low, conf.high, p.value) %>% 
  filter(term %in% c("(Intercept)", "victim_raceNonwhite")) %>% 
  knitr::kable()
```

| term                 |         OR|   conf.low|  conf.high|  p.value|
|:---------------------|----------:|----------:|----------:|--------:|
| (Intercept)          |  2.2589119|  2.0901172|  2.4419631|        0|
| victim\_raceNonwhite |  0.5816197|  0.5498223|  0.6151536|        0|

### run `glm` for each of the cities

``` r
nest_glm_res = 
  homi_df %>% 
  group_by(city_state) %>% 
  nest() %>% 
  mutate(models = map(data, ~glm(solved ~ victim_race + victim_age + victim_sex, data = .x, family = binomial())), 
         models_esti = map(models, broom::tidy), # tidying for estimate
         models_conf = map(models, broom::confint_tidy)) %>% # tyding for conf.int
  select(-data, -models) %>%
  unnest() %>% 
  filter(term %in% c("(Intercept)", "victim_raceNonwhite")) %>% 
  mutate(OR = exp(estimate), 
         conf.low = exp(conf.low), 
         conf.high = exp(conf.high)) %>% 
  select(city_state, term, OR, conf.low, conf.high, p.value)

nest_glm_res
```

    ## # A tibble: 94 x 6
    ##    city_state      term                   OR conf.low conf.high    p.value
    ##    <chr>           <chr>               <dbl>    <dbl>     <dbl>      <dbl>
    ##  1 Albuquerque, NM (Intercept)         4.35     2.27      8.57  0.0000134 
    ##  2 Albuquerque, NM victim_raceNonwhite 0.686    0.416     1.12  0.137     
    ##  3 Atlanta, GA     (Intercept)         2.89     1.47      5.81  0.00236   
    ##  4 Atlanta, GA     victim_raceNonwhite 0.767    0.433     1.32  0.348     
    ##  5 Baltimore, MD   (Intercept)         2.85     1.84      4.47  0.00000378
    ##  6 Baltimore, MD   victim_raceNonwhite 0.453    0.321     0.636 0.00000533
    ##  7 Baton Rouge, LA (Intercept)         4.39     1.73     11.9   0.00252   
    ##  8 Baton Rouge, LA victim_raceNonwhite 0.656    0.299     1.38  0.275     
    ##  9 Birmingham, AL  (Intercept)         1.85     0.941     3.66  0.0762    
    ## 10 Birmingham, AL  victim_raceNonwhite 1.05     0.619     1.76  0.862     
    ## # ... with 84 more rows

Then create a plot that shows the estimated ORs and CIs for each city, and comment on the plot.

``` r
nest_glm_res %>% 
  filter(term == "victim_raceNonwhite") %>% 
  ggplot(aes(x = reorder(city_state, OR), y = OR)) +
  geom_point() +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high)) +
  labs(x = "city", 
       y = "ORs and CIs for nonwhite victims comparing to white victims") + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

![](p8105_hw6_gw2383_files/figure-markdown_github/unnamed-chunk-4-1.png)
